<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Rezepte</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    header {
      background: #007bff;
      color: white;
      padding: 1rem;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { margin: 0; }
    header button {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }

    header button:hover { background: #218838; }
    .rezept-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }

    .rezept {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem;
      transition: transform 0.2s;
    }

    .rezept:hover { transform: scale(1.03); }
    .rezept h2 { margin: 0 0 0.5rem 0; font-size: 1.2rem; }
    .zutaten span {
      display: inline-block;
      background: #17a2b8;
      color: white;
      padding: 3px 8px;
      margin: 2px;
      border-radius: 8px;
      font-size: 0.8rem;
    }

    .hinweis {
      text-align: center;
      color: #888;
      font-style: italic;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Rezepte</h1>
    <button onclick="ladeRezepte()">ðŸ”„ Aktualisieren</button>
  </header>

  <div id="rezeptContainer" class="rezept-container">Lade Rezepte...</div>
  <p id="hinweis" class="hinweis"></p>

  <script>
    const rezeptOrdner = '/rezepte/';

    // === Hauptfunktion ===
    async function ladeRezepte()
    {
      const container = document.getElementById('rezeptContainer');
      const hinweis = document.getElementById('hinweis');
      container.innerHTML = 'Lade Rezepte...';
      hinweis.textContent = '';

      try
      {
        const dateien = await holeDateiliste();
        if (!dateien.length)
        {
          container.innerHTML = '<p style="text-align:center;">Keine Rezepte gefunden.</p>';
          return;
        }

        container.innerHTML = '';
        for (const datei of dateien)
        {
          try
          {
            const res = await fetch(rezeptOrdner + datei);
            if (!res.ok)
            {
              console.warn(`Konnte ${datei} nicht laden`);
              continue;
            }
            const rezept = await res.json();
            container.innerHTML += erzeugeRezeptHTML(rezept);
          } catch (err)
          {
            console.error('Fehler beim Laden des Rezepts', datei, err);
          }
        }

        if (container.innerHTML.trim() === '')
        {
          container.innerHTML = '<p style="text-align:center;">Keine Rezepte gefunden.</p>';
        }
      }
      catch (error)
      {
        console.error(error);
        container.innerHTML = '<p style="text-align:center;color:red;">Fehler beim Laden der Rezepte.</p>';
        hinweis.textContent = 'PrÃ¼fe, ob der ESP32 erreichbar ist und /rezepte/list verfÃ¼gbar ist.';
      }
    }

    // === Holt die Liste aller JSON-Dateien vom ESP32 ===
    async function holeDateiliste()
    {
      try
      {
        const res = await fetch('/rezepte/list');
        if (!res.ok) throw new Error('Fehler beim Abrufen der Dateiliste');
        const dateien = await res.json();
        return dateien.filter(name => name.endsWith('.json'));
      }
      catch (err)
      {
        console.error('Fehler beim Abrufen der Dateiliste:', err);
        return [];
      }
    }

    // === Baut HTML fÃ¼r ein Rezept zusammen ===
    function erzeugeRezeptHTML(rezept)
    {
      const zutatenHTML = rezept.zutaten
        .filter(z => z.ml[0] > 0)
        .map(z => `<span>${z.name}</span>`)
        .join('');
      return `
        <div class="rezept">
          <h2>${rezept.name}</h2>
          <p>${rezept.comment || ''}</p>
          <div class="zutaten">${zutatenHTML}</div>
        </div>
      `;
    }

    // Beim Laden der Seite automatisch starten
    document.addEventListener('DOMContentLoaded', ladeRezepte);
  </script>
</body>
</html>
