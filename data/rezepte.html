<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Rezepte</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #05203F;
      margin: 0;
      padding: 0;
    }

    header {
      background: #05203F;
      color: white;
      padding: 1rem;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { margin: 0; }
    header button {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }

    header button:first-of-type {
      margin-left: auto;
    }

    header button + button {
      margin-left: 0.3rem;
    }

    header button:hover { background: #218838; }
    .rezept-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }

    .rezept {
      background: #2c3e50;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      padding: 1rem;
      padding-left: 20px;           /* Platz für Farbstreifen */
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;             /* wichtig: Streifen + Radius sauber */
    }

    .rezept::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 10px;
      background: var(--rColor, #666);
    }

    .rezept:hover { transform: scale(1.03); }
    .rezept h2 { margin: 0 0 0.5rem 0; font-size: 1.2rem; }
    .zutaten span {
      display: inline-block;
      background: #1E1A3B;
      color: white;
      padding: 3px 8px;
      margin: 2px;
      border-radius: 8px;
      font-size: 0.8rem;
    }

    .useIcon{
      position:absolute;
      top:10px;
      right:10px;
      width:22px;
      height:22px;
      cursor:pointer;
      opacity:0.9;
    }
    .useIcon:hover{ opacity:1; }

    .hinweis {
      text-align: center;
      color: #888;
      font-style: italic;
      margin-top: 1rem;
    }

    .popup {
      position: fixed;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .popup.hidden {
      display: none;
    }

    .popup-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 400px;

      /* damit Popup nicht unendlich größer wird */
      max-height: 80vh;
      overflow: hidden;     /* damit nur innen gescrollt wird */
      display: flex;
      flex-direction: column;
    }

    /* Zutatenbereich - scrollt innerhalb des Popups */
    #zutatenContainer {
      margin-top: 8px;
      padding-right: 6px;   /* Platz für Scrollbar */
      overflow-y: auto;
      flex: 1;              /* nimmt restlichen Platz im Popup ein */
      min-height: 0;        /* wichtig für flex + overflow */
    }

    /* Damit Buttons unten bleiben */
    .popup-content .popup-actions {
      margin-top: 12px;
    }

    .ml-small {
      width: 2.5em;
      text-align: center;
    }

    hr.linebreak {
      border: none;
      height: 0;
      margin: 6px 0;
    }

    .zSelect {
      width: 180px;      /* nach Geschmack */
    }

    .zutaten span.zutat-missing {
      background: #b00020;   /* rot */
      color: #fff;
    }

    .color-select{
    width: 180px;
    padding-left: 28px; /* Platz für Farbbalken */
    border-radius: 6px;
    height: 28px;

    /* Farbbalken innen links (per CSS-Variable gesetzt) */
    background-image: linear-gradient(to right, var(--selColor, #666) 0 18px, #fff 18px 100%);
    background-repeat: no-repeat;
  }

  </style>
</head>
<body>
  <header>
    <button onclick="erstelleRezept()">Erstellen</button>
    <button onclick="ladeRezepte()">Aktualisieren</button>
    <!--button onclick="archiviereRezepte()">Rezepte speichern</button-->
    <!--button onclick="holeArchivierteRezepte()">Rezepte einholen</button-->
  </header>

  <div id="rezeptContainer" class="rezept-container", style="color:white">Lade Rezepte...</div>
  <p id="hinweis" class="hinweis"></p>

  <!-- Popup-Fenster -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
        <h2>Rezept erstellen</h2>

        <table>
          <tr>
            <th><label>Name:</label></th>
            <th><input id="rName" type="text"></th>
          </tr>
           <tr>
            <th><label>Use:</label></th>
            <th><input id="rUse" type="number"></th>
          </tr>
           <tr>
            <th><label>PLU:</label></th>
            <th><input id="rPlu" type="text"></th>
          </tr>
           <tr>
            <th><label>Gruppe:</label></th>
            <th><input id="rGroup" type="number"></th>
          </tr>
           <tr>
            <th><label>Farbe:</label></th>
            <th>
              <select id="rColor" class="color-select"></select>
            </th>
          </tr>
           <tr>
            <th><label>Kommentar:</label></th>
            <th><input id="rComment" type="text"></th>
          </tr>
        </table>
       
        <h3>Zutaten</h3>
        <div id="zutatenContainer"></div>

        <button id="addZutat">Zutat hinzufügen</button>

        <br><br>
        <div class="popup-actions">
          <button id="saveRecipe" style="background:#218838;color: white;">Rezept speichern</button>
          <button id="deleteRecipe" onclick="loescheRezept()" style="display:none;background:#dc3545;color:white;">Rezept löschen</button>
          <button id="closePopup" onclick="closePopup()">Abbrechen</button>
        </div>    
    </div>
  </div>

  <pre id="output"></pre>

  <script>
    const ICON_VISIBLE = "/web/pictures/Aktionsbilder/sichtbar.png";
    const ICON_HIDDEN  = "/web/pictures/Aktionsbilder/unsichtbar.png";
    
    const rezeptOrdner = '/rezepte/';
    let aktuellesRezept = null;
    let alleZutaten = [];

    // 12 Farbcodes
    const FARBCODES = [
      "#ffa500",   // Color_0
      "#daff00",   // Color_1
      "#A1FF00",   // Color_2
      "#00ff25",   // Color_3
      "#00ffa5",   // Color_4
      "#00daff",   // Color_5
      "#005aff",   // Color_6
      "#2500ff",   // Color_7
      "#a500ff",   // Color_8
      "#ff00d9",   // Color_9
      "#ff005a",   // Color_10
      "#ff2500"    // Color_11
    ];



    // ----------------------------------------------------
    // Initialisiert die Farbauswahl (rColor)
    // ----------------------------------------------------
    function initColorSelect()
    {
      const sel = document.getElementById("rColor");
      if (!sel) return;

      sel.innerHTML = "";

      FARBCODES.forEach((hex, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = `Farbe ${idx} (${hex})`;
        sel.appendChild(opt);
      });

      const updateStripe = () => {
        const i = Number(sel.value) || 0;
        sel.style.setProperty("--selColor", FARBCODES[i] || "#666");
      };

      sel.addEventListener("change", updateStripe);

      // Default
      sel.value = "0";
      updateStripe();
    }



    // ----------------------------------------------------
    // Lädt und sammelt eindeutige Zutaten aus products.json
    // ----------------------------------------------------
    async function ladeZutatenAusProducts()
    {
      try
      {
        // JSON-Datei laden (ohne Cache)
        const url = "/products/products.json";
        const res = await fetch(url, { cache: "no-store" });
        
        // HTTP-Fehler abfangen
        if (!res.ok) throw new Error("HTTP " + res.status);

        // JSON parsen
        const data = await res.json();

        // Zutaten-Namen extrahieren
        const arr = data.zutaten || [];
        const names = arr
          .map(z => (z.name || "").trim())
          .filter(n => n.length > 0);

        // Duplikate entfernen und sortieren
        alleZutaten = [...new Set(names)].sort((a, b) => a.localeCompare(b, "de"));

      }
      catch (e) // Fehlerbehandlung
      {
        console.error("Zutaten laden fehlgeschlagen:", e);
        alleZutaten = [];
      }
    }



    // ----------------------------------------------------
    // Befüllt ein Select-Feld mit Zutaten und setzt Auswah
    // ----------------------------------------------------
    function fuelleZutatenSelect(selectEl, selectedName)
    {
      selectEl.innerHTML = "";

      // Platzhalter
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "-- Zutat wählen --";
      selectEl.appendChild(opt0);

      // Optionen aus products.json
      for (const name of alleZutaten) {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      }

      // Auswahl setzen (falls vorhandene Zutat im Rezept)
      if (selectedName && alleZutaten.includes(selectedName))
      {
        selectEl.value = selectedName;
      }
      else if (selectedName)
      {
        // falls Rezept Zutat enthält die nicht in products.json ist:
        const optX = document.createElement("option");
        optX.value = selectedName;
        optX.textContent = selectedName + " (nicht in products)";
        selectEl.insertBefore(optX, selectEl.children[1]);
        selectEl.value = selectedName;
      }
    }



    // ----------------------------------------------------
    //  Holt alle JSON-Rezepte von der SD-Karte
    // ----------------------------------------------------
    async function ladeRezepte()
    {
      const container = document.getElementById('rezeptContainer');
      const hinweis = document.getElementById('hinweis');
      container.innerHTML = 'Lade Rezepte...';
      hinweis.textContent = '';

      try
      {
        const dateien = await holeDateiliste();
        if (!dateien.length)
        {
          container.innerHTML = '<p style="text-align:center;color:white">Keine Rezepte gefunden.</p>';
          return;
        }

        container.innerHTML = '';
        for (const datei of dateien)
        {
          try
          {
            const res = await fetch(rezeptOrdner + datei);
            if (!res.ok)
            {
              console.warn(`Konnte ${datei} nicht laden`);
              continue;
            }
            const rezept = await res.json();
            container.innerHTML += erzeugeRezeptHTML(rezept);
          } catch (err)
          {
            console.error('Fehler beim Laden des Rezepts', datei, err);
          }
        }

        if (container.innerHTML.trim() === '')
        {
          container.innerHTML = '<p style="text-align:center;color:white">Keine Rezepte gefunden.</p>';
        }
      }
      catch (error)
      {
        console.error(error);
        container.innerHTML = '<p style="text-align:center;color:red;">Fehler beim Laden der Rezepte.</p>';
      }
    }



    // ----------------------------------------------------
    //  Erstellt Rezepte als JSON
    // ----------------------------------------------------
    function erstelleRezept()
    {
      window._editMode = false;
      openPopup((recipe) => {
        speichereRezept(recipe);
      });
    }



    // ----------------------------------------------------
    //  Bearbeitet Rezepte im Popup
    // ----------------------------------------------------
    function bearbeiteRezept(rezeptString)
    {
      window._editMode = true;                  // Edit-Modus aktivieren
      const rezept = JSON.parse(rezeptString);  // Rezept aus String laden

      aktuellesRezept = rezept;                 // für löschen merken

      openPopup((updatedRecipe) => {
        speichereRezept(updatedRecipe);
      });

      // --- Felder befüllen ---
      document.getElementById("rName").value = rezept.name;
      document.getElementById("rUse").value = rezept.use;
      document.getElementById("rPlu").value = rezept.plu;
      document.getElementById("rGroup").value = rezept.group;
      document.getElementById("rColor").value = rezept.color;
      document.getElementById("rColor").style.setProperty("--selColor", FARBCODES[rezept.color] || "#666");
      document.getElementById("rComment").value = rezept.comment;

      // --- Zutaten setzen ---
      const container = document.getElementById("zutatenContainer");
      container.innerHTML = "";

      rezept.zutaten.forEach(zutat => {
        const div = document.createElement("div");
        div.classList.add("zutat");

        div.innerHTML = `
          <label>Name:</label>
          <select class="zName zSelect" size="3"></select>

          <hr class="linebreak">

          <label>ml 1:</label>
          <input type="number" max="99" min="0" class="zMl1 ml-small"
                value="${(zutat.ml && zutat.ml[0] != null) ? zutat.ml[0] : 0}">

          <label>ml 2:</label>
          <input type="number" max="99" min="0" class="zMl2 ml-small"
                value="${(zutat.ml && zutat.ml[1] != null) ? zutat.ml[1] : 0}">

          <button class="removeZutat">X</button>
          <hr>
        `;

        const sel = div.querySelector(".zName");
        fuelleZutatenSelect(sel, zutat.name);

        div.querySelector(".removeZutat").onclick = () => {
          div.remove();
          updateZutatenScroll();
        };

        container.appendChild(div);
      });
      updateZutatenScroll();
    }



    // ----------------------------------------------------
    //  Achiviert alle Rezepte
    // ----------------------------------------------------
    function archiviereRezepte()
    {
      //...
    }



    // ----------------------------------------------------
    //  Holt achivierte Rezepte
    // ----------------------------------------------------
    function holeArchivierteRezepte()
    {
      /*
      {
      "name": "Tequila Sunrise",
      "use": 1,
      "plu": "000",
      "group": 0,
      "color": 3,
      "comment": " ",
      "zutaten": [
        {
            "name": "Grenadine",
            "ml": [
                0,
                20
            ]
        },...
      }
      */
    }

    

    // ----------------------------------------------------
    //  Holt die Liste aller JSON-Dateien vom ESP32
    // ----------------------------------------------------
    async function holeDateiliste()
    {
      try
      {
        const res = await fetch('/rezepte/list');
        if (!res.ok) throw new Error('Fehler beim Abrufen der Dateiliste');
        const dateien = await res.json();
        return dateien.filter(name => name.endsWith('.json'));
      }
      catch (err)
      {
        console.error('Fehler beim Abrufen der Dateiliste:', err);
        return [];
      }
    }



    // ----------------------------------------------------
    //  Baut HTML für ein Rezept zusammen
    // ----------------------------------------------------
    function erzeugeRezeptHTML(rezept)
    {
      const zutatenHTML = rezept.zutaten
        .filter(z =>
          (Number(z.ml?.[0] ?? 0) > 0) ||
          (Number(z.ml?.[1] ?? 0) > 0)
        )
        .map(z => {
          const name = (z.name || "").trim();
          const isMissing = !alleZutaten.includes(name);
          const cls = isMissing ? "zutat-missing" : "";
          return `<span class="${cls}">${name}</span>`;
        })
        .join('');

      const rezeptJson = encodeURIComponent(JSON.stringify(rezept));

      const colorIdx = Number(rezept.color ?? 0);
      const hex = FARBCODES[colorIdx] || "#666";

      // use + icon pro Rezept berechnen
      const useVal = Number(rezept.use ?? 0);                 // 0 sichtbar, 1 nicht sichtbar
      const iconSrc = (useVal === 1) ? ICON_HIDDEN : ICON_VISIBLE;

      return `
        <div class="rezept" style="color:white; --rColor: ${hex};"
            onclick="bearbeiteRezept(decodeURIComponent('${rezeptJson}'))">

          <img class="useIcon"
              src="${iconSrc}"
              data-use="${useVal}"
              onclick="toggleUse(event, this, decodeURIComponent('${rezeptJson}'))"
              alt="use">

          <h2>${rezept.name}</h2>
          <p>${rezept.comment || ''}</p>
          <div class="zutaten">
            ${zutatenHTML || '<span style="opacity:.6">Keine Zutaten</span>'}
          </div>
        </div>
      `;
    }



    // ----------------------------------------------------
    //  Zutaten hinzufügen
    // ----------------------------------------------------
    function speichereRezept(recipe)
    {
      fetch("/saveRecipe", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "body=" + encodeURIComponent(JSON.stringify(recipe))
      })
      .then(r => r.text())
      .then(t => alert(t));
    }



    // ----------------------------------------------------
    //  Popup öffnen
    // ----------------------------------------------------
    function openPopup(onSaveCallback)
    {
      // Callback speichern
      window._popupCallback = onSaveCallback;

      const deleteBtn = document.getElementById("deleteRecipe");

      if (window._editMode)
      {
        deleteBtn.style.display = "inline-block";
      }
      else
      {
        deleteBtn.style.display = "none";

        document.getElementById("rName").value = "";
        document.getElementById("rUse").value = "";
        document.getElementById("rPlu").value = "";
        document.getElementById("rGroup").value = "";
        document.getElementById("rColor").value = "0";
        document.getElementById("rColor").style.setProperty("--selColor", FARBCODES[0] || "#666");
        document.getElementById("rComment").value = "";
        document.getElementById("zutatenContainer").innerHTML = "";   
        aktuellesRezept = null;                                      

        // direkt eine Zutat-Zeile anlegen
        document.getElementById("addZutat").click();
      }

      document.getElementById("popup").classList.remove("hidden");

      updateZutatenScroll();
    }



    // ----------------------------------------------------
    //  Automatische Scrollfunktion hinzufügen - Aktion im Popup-Fenster
    // ----------------------------------------------------
    function updateZutatenScroll()
    {
      const container = document.getElementById("zutatenContainer");
      const count = container.querySelectorAll(".zutat").length;

      if (count >= 3)
      {
        container.style.maxHeight = "220px"; // kannst du anpassen
        container.style.overflowY = "auto";
      }
      else
      {
        container.style.maxHeight = "none";
        container.style.overflowY = "visible";
      }
    }



    // ----------------------------------------------------
    //  Popup schließen
    // ----------------------------------------------------
    function closePopup()
    {
      document.getElementById("popup").classList.add("hidden");
      window._editMode = false;
      aktuellesRezept = null;
    }



    // ----------------------------------------------------
    //  ausgewähltes Rezept löschen - Aktion im Popup-Fenster
    // ----------------------------------------------------
    function loescheRezept()
    {
      if (!aktuellesRezept) return;

      if (!confirm("Willst du dieses Rezept wirklich löschen?"))
        return;

      fetch("/deleteRecipe", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "body=" + encodeURIComponent(JSON.stringify(aktuellesRezept))
      })
      .then(r => r.text())
      .then(t => {
        alert(t);

        closePopup();
        aktuellesRezept = null;
        window._editMode = false;
        ladeRezepte();
      });
    }



    // ----------------------------------------------------
    //  Zutaten hinzufügen
    // ----------------------------------------------------
    document.getElementById("addZutat").onclick = () => {
      const container = document.getElementById("zutatenContainer");

      const div = document.createElement("div");
      div.classList.add("zutat");

      div.innerHTML = `
      <label>Name:</label>
      <select class="zName zSelect" size="3"></select>

      <hr class="linebreak">

      <label>ml 1:</label>
      <input type="number" max="99" min="0"
            class="zMl1 ml-small"
            value="0">

      <label>ml 2:</label>
      <input type="number" max="99" min="0"
            class="zMl2 ml-small"
            value="0">

      <button class="removeZutat">X</button>
      <hr>
      `;

      // Select erstmal leer/mit Platzhalter füllen
      const sel = div.querySelector(".zName");
      fuelleZutatenSelect(sel, "");

      div.querySelector(".removeZutat").onclick = () => {
        div.remove();
        updateZutatenScroll();
      };

      container.appendChild(div);
      updateZutatenScroll();
    };



    // ----------------------------------------------------
    //  ...
    // ----------------------------------------------------
    async function saveRecipeSilent(recipe)
    {
      const res = await fetch("/saveRecipe", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "body=" + encodeURIComponent(JSON.stringify(recipe))
      });
      if (!res.ok) throw new Error("Save failed: " + res.status);
      return await res.text();
    }



    // ----------------------------------------------------
    //  Klick auf Icon: use toggeln, Icon wechseln, speichern (ohne Seite neu zu laden)
    // ----------------------------------------------------
    async function toggleUse(ev, imgEl, rezeptString)
    {
      ev.stopPropagation(); // verhindert "Card klick" => bearbeiten

      let rezept;
      try
      {
        rezept = JSON.parse(rezeptString);
      }
      catch (e)
      {
        console.error("Bad rezept json:", e);
        return;
      }

      // toggle: 0 sichtbar, 1 nicht sichtbar
      rezept.use = (Number(rezept.use ?? 0) === 1) ? 0 : 1;

      // UI sofort updaten
      imgEl.dataset.use = String(rezept.use);
      imgEl.src = (rezept.use === 1) ? ICON_HIDDEN : ICON_VISIBLE;

      // speichern (ohne reload)
      try
      {
        await saveRecipeSilent(rezept);
      }
      catch (e)
      {
        console.error(e);
        // rollback, falls speichern fehlschlägt
        rezept.use = (rezept.use === 1) ? 0 : 1;
        imgEl.dataset.use = String(rezept.use);
        imgEl.src = (rezept.use === 1) ? ICON_HIDDEN : ICON_VISIBLE;
        alert("Konnte 'use' nicht speichern!");
      }
    }



    // ----------------------------------------------------
    //  Speichern des Rezepts + Callback ausführen
    // ----------------------------------------------------
    document.getElementById("saveRecipe").onclick = () => {

      const recipe = {
        name: document.getElementById("rName").value,
        use: Number(document.getElementById("rUse").value),
        plu: document.getElementById("rPlu").value,
        group: Number(document.getElementById("rGroup").value),
        color: Number(document.getElementById("rColor").value),
        comment: document.getElementById("rComment").value,
        zutaten: []
      };

      const zDivs = document.querySelectorAll(".zutat");
      zDivs.forEach(div => {
        const name = div.querySelector(".zName").value;
        const ml1 = Number(div.querySelector(".zMl1")?.value ?? 0);
        const ml2 = Number(div.querySelector(".zMl2")?.value ?? 0);

        const hasMl = (ml1 > 0) || (ml2 > 0);

        if (name.trim().length > 0 && hasMl) 
        {
          recipe.zutaten.push({ name, ml: [ml1, ml2] });
        }
      });

      // Hilfstext Ausgabe auf der Seite (Optional)
      /*document.getElementById("output").textContent =
          JSON.stringify(recipe, null, 4);*/
          
      // Wenn ein Callback existiert → ausführen
      if (typeof window._popupCallback === "function")
      {
          window._popupCallback(recipe);
      }

      closePopup();
      aktuellesRezept = null;
      window._editMode = false;
      ladeRezepte();
      // Wenn neues Rezept angelegt, dann aktualisierungsbutton betätigen
    };

    // Beim Laden der Seite automatisch starten
    document.addEventListener('DOMContentLoaded', async () => {
      initColorSelect();
      await ladeZutatenAusProducts();
      ladeRezepte();
    });

  </script>
</body>
</html>
